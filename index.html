<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PIXEL event gold</title>
<style>
  :root { --bg:#0b1220; --fg:#e6f1ff; --muted:#9fb1c6; --card:#111a2b; --border:#223045; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  header{padding:24px 20px;border-bottom:1px solid var(--border)}
  h1{margin:0;font-size:20px;letter-spacing:.2px}
  main{max-width:1100px;margin:0 auto;padding:20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 4px 14px rgba(0,0,0,.25)}
  .hint{color:var(--muted);font-size:13px;margin:10px 0 0}
  .table-wrap{overflow:auto;margin-top:8px}
  table{border-collapse:collapse;width:100%;min-width:520px}
  thead th{position:sticky;top:0;background:#0f192b;text-align:left;font-weight:600;border-bottom:1px solid var(--border);padding:10px;cursor:pointer}
  tbody td{border-bottom:1px solid rgba(255,255,255,.07);padding:10px;font-size:14px}
  tbody tr:hover{background:rgba(255,255,255,.04)}
  .controls{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .controls a{color:var(--fg);font-size:13px;text-decoration:none;border:1px solid var(--border);padding:6px 10px;border-radius:10px}
  .controls a:hover{border-color:#20e39c}
  .error{color:#ffb4b4}
</style>
</head>
<body>
  <header>
    <h1>PIXEL event gold</h1>
  </header>

  <main>
    <section class="card">
      <div class="controls">
        <h2 style="margin:0;font-size:16px">Таблица</h2>
        <a id="download-link" href="./user_total.csv" download>Скачать CSV</a>
      </div>
      <p class="hint">Данные загружаются из <code>user_total.csv</code>. Клик по заголовку — сортировка.</p>
      <div class="table-wrap">
        <table id="data-table" aria-label="Таблица PIXEL event gold">
          <thead><tr><!-- headers injected --></tr></thead>
          <tbody><!-- rows injected --></tbody>
        </table>
      </div>
      <p id="status" class="hint"></p>
    </section>
  </main>

<script>
(async function(){
  const status = document.getElementById('status');
  const dl = document.getElementById('download-link');

  // Путь к файлу: пробуем относительный и корневой (если index.html в подпапке)
  const candidates = ['./user_total.csv', '/user_total.csv'];

  try {
    const res = await tryFetchAny(candidates, {cache:'no-store'});
    if (!res) throw new Error('Файл не найден ни по одному пути');
    // обновим href на реально сработавший путь
    dl.href = res.url;

    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) {
      status.textContent = 'CSV пустой.';
      return;
    }
    renderTable('data-table', rows);
    status.textContent = 'Загружено строк: ' + (rows.length - 1);
  } catch (e) {
    status.innerHTML = 'Не удалось загрузить <code>user_total.csv</code>. ' +
      '<span class="error">' + (e.message || e) + '</span>';
  }

  async function tryFetchAny(paths, opts){
    for (const p of paths){
      try {
        const r = await fetch(p, opts);
        if (r.ok) return r;
      } catch(_) {}
    }
    return null;
  }

  // CSV/TSV парсер с автоопределением разделителя (",", ";", "\t")
  function parseCSV(text) {
    const content = text.replace(/\r/g,'').trim();
    if (!content) return [];
    const lines = content.split('\n');

    const delim = detectDelimiter(lines[0]);

    return lines.map(line => {
      const out = [];
      let cur = '', q = false;
      for (let i=0; i<line.length; i++){
        const ch = line[i], nx = line[i+1];
        if (ch === '"'){
          if (q && nx === '"'){ cur+='"'; i++; }
          else { q = !q; }
        } else if (ch === delim && !q){ out.push(cur); cur=''; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    });
  }

  function detectDelimiter(firstLine){
    // считаем разделители вне кавычек
    const candidates = [',','\t',';'];
    const counts = Object.fromEntries(candidates.map(c => [c,0]));
    let q=false;
    for (let i=0;i<firstLine.length;i++){
      const ch = firstLine[i], nx = firstLine[i+1];
      if (ch === '"'){
        if (q && nx === '"'){ i++; } else { q=!q; }
      } else if (!q && candidates.includes(ch)){
        counts[ch]++;
      }
    }
    // берём самый частый; по умолчанию — запятая
    let best = ',', max = -1;
    for (const c of candidates){
      if (counts[c] > max){ max = counts[c]; best = c; }
    }
    return best;
  }

  function renderTable(id, rows) {
    const table = document.getElementById(id);
    const thead = table.tHead.rows[0];
    const tbody = table.tBodies[0];

    const headers = rows[0];
    thead.innerHTML = headers.map(h => `<th>${escapeHTML(h)}</th>`).join('');

    const frag = document.createDocumentFragment();
    for (let r = 1; r < rows.length; r++) {
      const tr = document.createElement('tr');
      tr.innerHTML = rows[r].map(v => `<td>${escapeHTML(v)}</td>`).join('');
      frag.appendChild(tr);
    }
    tbody.innerHTML = '';
    tbody.appendChild(frag);

    // сортировка по клику
    let sortIdx = -1, asc = true;
    [...thead.cells].forEach((th, i) => {
      th.addEventListener('click', () => {
        asc = (sortIdx === i) ? !asc : true;
        sortIdx = i;
        sortTable(tbody, i, asc);
      });
    });
  }

  function val(v){
    const n = Number(v.replace?.(/\s/g,'') ?? v);
    if (!isNaN(n)) return n;
    const d = new Date(v);
    if (!isNaN(d)) return d.getTime();
    return (v ?? '').toString().toLowerCase();
  }

  function sortTable(tbody, i, asc){
    const rows = Array.from(tbody.rows);
    rows.sort((a,b) => {
      const av = val(a.cells[i].innerText.trim());
      const bv = val(b.cells[i].innerText.trim());
      return asc ? (av>bv?1:av<bv?-1:0) : (av<bv?1:av>bv?-1:0);
    });
    tbody.innerHTML = '';
    rows.forEach(r => tbody.appendChild(r));
  }

  function escapeHTML(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }
})();
</script>
</body>
</html>
