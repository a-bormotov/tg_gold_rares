<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gold Rush Event Leaderboard</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
  margin: 0;
  font-family: 'Nunito Sans', sans-serif;
  background: #1d2739;
  color: #91a0b5;
  text-align: center;
}
.container { padding: 20px; max-width: 1000px; margin: 0 auto; }
.top-info { background: #312957; padding: 10px; margin-bottom: 15px; font-size: 14px; color: #bf83fb; }
.top-info .bullet { display:inline-block; width:6px; height:6px; background:#bf83fb; border-radius:50%; margin-right:6px; animation:pulse 1.5s infinite; }
.top-info a { color:#bf83fb; text-decoration:underline; margin-left:6px; }
@keyframes pulse { 0%{opacity:1} 50%{opacity:.4} 100%{opacity:1} }
.event-title { font-size:28px; color:#b587fb; margin:10px 0; }
.event-subtitle { font-size:16px; color:#cbd5e1; }
.prize-pool { font-size:24px; font-weight:bold; color:#facc14; margin:15px 0; }
.event-details { font-size:14px; color:#cad4e0; margin-bottom:8px; }
.event-details svg { width:16px; height:16px; stroke:#94a3b8; fill:none; stroke-width:2; vertical-align:middle; margin:0 4px; }
.disclaimer { font-size:12px; color:#cbd5e1; opacity:.7; margin-bottom:20px; }
.scoring-panel { background:#1d273a; border:1px solid #94a3b8; padding:15px; margin:20px auto; width:70%; font-size:12px; }
.scoring-panel .section-title { color:#d8b3fe; font-weight:bold; margin-bottom:10px; }
.scoring-panel .item { margin:4px 0; }
.scoring-panel .rare { color:#5fa5f9; } .scoring-panel .epic { color:#bc82f8; } .scoring-panel .legendary { color:#fb923c; }
.previous-panel { background:#22564f; border:1px solid #269759; padding:15px; margin:20px auto; width:70%; }
.previous-panel .title { color:#49de80; font-weight:bold; }
.previous-panel .pulse-dot { display:inline-block; width:6px; height:6px; background:#49de80; border-radius:50%; margin:0 6px; animation:pulse 1.5s infinite; }
.status-button { display:inline-block; margin-top:10px; background:#16a349; color:#fff; padding:8px 12px; border-radius:5px; text-decoration:none; transition:transform .2s; }
.status-button:hover { transform:scale(1.05); }
.search-box { margin:20px auto; position:relative; width:320px; }
.search-box input { width:100%; padding:10px 12px 10px 36px; border-radius:6px; border:1px solid #94a3b8; background:#1d2739; color:#94a3b8; }
.search-box input::placeholder { color:#94a3b8; }
.search-icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); width:16px; height:16px; }
.search-icon circle, .search-icon line { stroke:#94a3b8; stroke-width:2; fill:none; }
.last-updated { color:#94a3b8; font-size:12px; margin:10px 0 20px 0; }
.last-updated svg { width:14px; height:14px; stroke:#94a3b8; stroke-width:2; fill:none; vertical-align:middle; margin-right:4px; }
.leaderboard-title { background:#8239ed; color:#fff; padding:10px; font-size:20px; margin-bottom:10px; }
.table-container { max-height:400px; overflow-y:auto; margin:auto; width:90%; }
table { border-collapse:collapse; width:100%; font-size:13px; }
thead th { position:sticky; top:0; background:#2c394c; color:#dfe5ee; padding:8px; }
tbody td { padding:8px; border-bottom:1px solid #2a3447; }
tbody tr:hover { background:#2c394c; }
tbody tr:nth-child(1) { background:#413e2f; color:#fff; font-weight:bold; }
tbody tr:nth-child(2) { background:#313e51; color:#fff; font-weight:bold; }
tbody tr:nth-child(3) { background:#473431; color:#fff; font-weight:bold; }
.stats { display:flex; justify-content:center; gap:20px; margin-top:20px; }
.stat-box { flex:1; padding:10px; }
.stat-box div:first-child { font-size:28px; font-weight:bold; }
.small-hint { font-size:12px; opacity:.8; margin-top:6px; }
.download { display:inline-block; margin:10px 0; color:#bf83fb; text-decoration:underline; }
.error { color:#ffb4b4; }
</style>
</head>
<body>
<div class="container">

<!-- Top info -->
<div class="top-info">
  <span class="bullet"></span>Gold and heroes must be acquired during the event to be counted.
  <a href="https://game.sleepagotchi.com/">Play now</a>
</div>

<div class="event-title">Gold Rush Event</div>
<div class="event-subtitle">Sleepagotchi x PIXELS Collaboration</div>
<div class="prize-pool">Prize Pool: 500 000 PIXELS (≈ 17 000 USD)</div>
<div class="event-details">
  <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
  September 11, X UTC - September 16, X UTC
  <svg viewBox="0 0 24 24"><path d="M6 3h12v2a6 6 0 0 1-6 6 6 6 0 0 1-6-6V3z"/><rect x="9" y="11" width="6" height="10"/></svg>
  Top 1,000 Players
</div>
<div class="disclaimer">
  Prizes are paid in $PIXEL to Ronin addresses. USD values are for reference only, based on a rate of $0.031 per $PIXEL. Actual value may vary due to token price volatility.
</div>

<!-- Scoring -->
<div class="scoring-panel">
  <div class="section-title">Scoring System</div>
  <div class="item">Collect Gold Coins to climb the leaderboard</div>
  <div class="item">Boost your rewards with Hero Card multipliers from the Gacha in Sleepagotchi LITE</div>
  <div class="item rare">Rare Card - X %</div>
  <div class="item epic">Epic Card - X %</div>
  <div class="item legendary">Legendary Card - X %</div>
</div>

<!-- Previous event -->
<div class="previous-panel">
  <div class="title">
    <span class="pulse-dot"></span>
    Previous Event distributions:
    <span class="pulse-dot"></span>
  </div>
  <a href="https://docs.google.com/spreadsheets/d/1E_7LAP6L8aMDgVoZnHyuvA0_F5qCO0BuLafDA6s_4p4/edit?gid=624560673#gid=624560673" class="status-button">
    Check Your Status Here &#x2197;
  </a>
</div>

<!-- Search -->
<div class="search-box">
  <svg class="search-icon" viewBox="0 0 24 24">
    <circle cx="11" cy="11" r="8"/><line x1="17" y1="17" x2="22" y2="22"/>
  </svg>
  <input type="text" placeholder="Find yourself a friend..." id="searchInput">
  <div class="small-hint">Data source: <code>user_total.csv</code> (root). <a id="csvLink" class="download" href="./user_total.csv" download>Download CSV</a></div>
  <div id="loadStatus" class="small-hint"></div>
</div>

<!-- Last updated -->
<div class="last-updated" id="lastUpdated">
  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="6" x2="12" y2="12"/><line x1="12" y1="12" x2="16" y2="14"/></svg>
  Last Updated: —
</div>

<!-- Leaderboard -->
<div class="leaderboard-title">LEADERBOARD</div>
<div class="table-container">
  <table id="leaderboard">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Username</th>
        <th>Score</th>
        <th>Gold</th>
        <th>Rare</th>
        <th>Epic</th>
        <th>Legendary</th>
        <th>PIXEL</th>
        <th>USD (ref.)</th>
      </tr>
    </thead>
    <tbody id="tbody"><tr><td colspan="9">Loading…</td></tr></tbody>
  </table>
</div>

<!-- Bottom stats -->
<div class="stats">
  <div class="stat-box" style="background:#1f423e;color:#baf7d0;">
    <div style="color:#fff;" id="qualifyingCount">–</div>
    <div>Qualifying Players</div>
  </div>
  <div class="stat-box" style="background:#403533;color:#e4d57d;">
    <div style="color:#fff;">500,000</div>
    <div>Total PIXEL Pool</div>
  </div>
  <div class="stat-box" style="background:#2b2656;color:#c2b2dd;">
    <div style="color:#fff;">$17,000</div>
    <div>Total USD Pool</div>
  </div>
</div>

<script>
// --- Helpers ---
function detectDelimiter(firstLine){
  const candidates = [',','\t',';'];
  const counts = {',':0,'\t':0,';':0};
  let q=false;
  for (let i=0;i<firstLine.length;i++){
    const ch = firstLine[i], nx = firstLine[i+1];
    if (ch === '"'){ if (q && nx === '"'){ i++; } else { q=!q; } }
    else if (!q && counts.hasOwnProperty(ch)) counts[ch]++;
  }
  let best = ',', max=-1;
  for (const c of candidates){ if (counts[c]>max){ max=counts[c]; best=c; } }
  return best;
}

function parseCSV(text){
  const content = text.replace(/\r/g,'').trim();
  if (!content) return [];
  const lines = content.split('\n');
  const delim = detectDelimiter(lines[0]);

  const rows = lines.map(line=>{
    const out=[], n=line.length; let cur='', q=false;
    for (let i=0;i<n;i++){
      const ch=line[i], nx=line[i+1];
      if (ch === '"'){
        if (q && nx === '"'){ cur+='"'; i++; }
        else { q=!q; }
      } else if (ch === delim && !q){ out.push(cur); cur=''; }
      else { cur += ch; }
    }
    out.push(cur);
    return out;
  });
  return rows;
}
function toNumber(x){ const n=Number(String(x??'').replace(/\s|,/g,'')); return isNaN(n)?0:n; }
function fmtInt(n){ return n.toLocaleString('en-US'); }
function nowDateString(){
  const d=new Date();
  return d.toLocaleDateString('en-US'); // e.g. 09/11/2025
}

// --- Load CSV and render ---
(async function(){
  const statusEl = document.getElementById('loadStatus');
  const lastEl = document.getElementById('lastUpdated');
  const csvLink = document.getElementById('csvLink');
  const tbody = document.getElementById('tbody');
  const qualifyingEl = document.getElementById('qualifyingCount');

  try{
    // Fetch from root; prevent GH Pages cache
    const url = './user_total.csv';
    csvLink.href = url;
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();

    const rows = parseCSV(text);
    if (!rows.length) throw new Error('CSV is empty');

    const headers = rows[0].map(h => String(h).trim());
    const idx = Object.fromEntries(headers.map((h,i)=>[h.toLowerCase(), i]));

    // Desired fields
    const has = (name) => idx.hasOwnProperty(name);
    const gi = (row, name) => row[idx[name]];

    // Build objects, filling missing fields as needed
    let data = rows.slice(1).map(r=>{
      const gold = has('gold') ? toNumber(gi(r,'gold')) : 0;
      const score = has('score') ? toNumber(gi(r,'score')) : gold;
      return {
        username: has('username') ? gi(r,'username') : '',
        gold,
        rares: has('rares') ? toNumber(gi(r,'rares')) : 0,
        epics: has('epics') ? toNumber(gi(r,'epics')) : 0,
        legendaries: has('legendaries') ? toNumber(gi(r,'legendaries')) : 0,
        score
      };
    });

    // Sort by score desc, then gold desc, then username
    data.sort((a,b)=> b.score - a.score || b.gold - a.gold || String(a.username).localeCompare(String(b.username)));

    // Assign rank (if CSV already had rank, we ignore it to keep consistent ordering)
    data.forEach((row, i)=> row.rank = i+1);

    // Render table
    const frag = document.createDocumentFragment();
    for (const row of data){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.rank}</td>
        <td>${escapeHTML(row.username)}</td>
        <td>${fmtInt(row.score)}</td>
        <td>${fmtInt(row.gold)}</td>
        <td>${fmtInt(row.rares)}</td>
        <td>${fmtInt(row.epics)}</td>
        <td>${fmtInt(row.legendaries)}</td>
        <td>0</td>
        <td>$0</td>
      `;
      frag.appendChild(tr);
    }
    tbody.innerHTML = '';
    tbody.appendChild(frag);

    qualifyingEl.textContent = fmtInt(data.length);
    lastEl.innerHTML = `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="6" x2="12" y2="12"/><line x1="12" y1="12" x2="16" y2="14"/></svg> Last Updated: ${nowDateString()}`;
    statusEl.textContent = `Loaded rows: ${data.length}`;
  } catch(e){
    statusEl.innerHTML = `Failed to load <code>user_total.csv</code>. <span class="error">${e.message || e}</span>`;
    console.error(e);
  }

  // Search functionality
  const input = document.getElementById('searchInput');
  input.addEventListener('input', function() {
    const filter = input.value.toUpperCase();
    const trs = document.getElementById('leaderboard').getElementsByTagName('tr');
    for (let i = 1; i < trs.length; i++) {
      const td = trs[i].getElementsByTagName('td')[1];
      if (td) {
        const txtValue = td.textContent || td.innerText;
        trs[i].style.display = txtValue.toUpperCase().includes(filter) ? '' : 'none';
      }
    }
  });

  function escapeHTML(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }
})();
</script>
</div>
</body>
</html>
